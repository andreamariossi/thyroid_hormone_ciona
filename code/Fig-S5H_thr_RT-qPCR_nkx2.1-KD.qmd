---
title: "Fig-S5H_thr_RT-qPCR_nkx2.1-KD"
author: "Andrea Mariossi"
format: 
  html:
    code-fold: false
    embed-resources: true 
engine: knitr
editor: visual
grid: 
  sidebar-width: 100px
  body-width: 2000px
  margin-width: 100px
  gutter-width: 3.5rem
execute:
  fig-align: center
---

# Nkx2.1 CRISPR-Cas9 RT-qPCR

---
# #| column: screen
# #| out-width: 50%
# #| column: screen
# #| out-width: 50%
# #| fig-format: svg
# #| fig-align: center
---

```{r}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE, 
  warning = FALSE,
  # fig.width = 8,
  # fig.height = 6,
  fig.align = "center",
  out.width = "70%",
  column = "page"
)

rm(list = ls())

# Package loading
suppressPackageStartupMessages({
  # Data manipulation & file import
  library(tidyverse)
  library(readxl)
  library(paletteer)
  library(rstatix)
  library(ggpubr)
  library(knitr)
  library(Cairo)
  library(lme4)
  library(lmerTest)
  library(emmeans)
  library(kableExtra)
  })

```

## Data Loading and Preprocessing

```{r}
# ===== path =====
file_path <- "/Users/andrea/Princeton Dropbox/Andrea Mariossi/4.paper_archive/2025_thyroid_pathway_&_metamorphosis/3.1.ScienceAdvances_submission_rev/tables/"

# ===== theme & style =====
custom_theme <- function() {
  theme(
    axis.ticks = element_line(size = 0.5),
    axis.ticks.length = unit(0.09, "cm"),
    legend.key.height = unit(20, "pt"),
    axis.line = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 1),
    panel.background = element_blank(),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.background = element_blank(),
    legend.box.background = element_blank(),
    legend.key = element_blank(),
    strip.background = element_blank(),
  )
}

# ===== set theme =====
theme_set(theme_pubr(base_size = 13,
                     base_family = "Helvetica") + custom_theme())

# ===== extra bits =====
no_legend <- theme(legend.position = "none")
axis_text_45 <- theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# ===== color palette =====
contPalette <- paletteer_c("ggthemes::Red-Green-Gold Diverging", 30)

stage_order <- c("earTII", "midTII", "latTII", "latTIII", "larva")

# ===== pretty p-values for kable =====
format_pvalues <- function(df) {
  df %>%
    mutate(across(any_of(c("p.value", "p.value.x", "p.value.y", "adj.p.value")), 
                  ~ case_when(
                    . < 0.001 ~ format(., scientific = TRUE, digits = 2),
                    TRUE ~ as.character(round(., 4))
                  )))
}
```

## Quality Control: Raw Ct Values

```{r}
# Load data
qPCR_GRN <- read_excel(paste0(file_path,"4_sgNkx2.1_thr_qPCR.xlsx"))
qPCR_GRN

qPCR_GRN <- qPCR_GRN |> dplyr::mutate(
    stage = factor(
      stage,
      levels = c("earTII", "midTII", "latTII", "latTIII", "larva")
    )
  )
# Calculating average Ct values for technical replicates
summarised_data <- qPCR_GRN %>%
  pivot_longer(cols = 5:10, names_to = "type", values_to = "Ct") %>%
  separate(type, into = c("gene", "tecRep"), sep = "_", convert = TRUE) %>%
  mutate(gene = as.factor(gene),
         bioRep = as.numeric(bioRep)) |>
  #        bioRep = as.numeric(gsub("tecRep", "", bioRep))) |> 
  group_by(gene, group,stage,hpf,bioRep) %>%
  summarise(mean_Ct = mean(Ct), .groups = "drop")

# Plot average Ct values
# actin & thr
ct_plot <- ggplot(summarised_data, aes(x = group, y = mean_Ct, colour = hpf)) +
  geom_point(size = 2, alpha = 0.7) +
  scale_color_gradientn(colors = contPalette, name = "early to late hpf") +
  facet_wrap(~ gene, scales = "fixed") +
  custom_theme()

# just actin
ggplot(summarised_data |> filter(gene== "actin"), aes(x = group, y = mean_Ct, colour = hpf)) +
  geom_point(size = 2, alpha = 0.7) +
  scale_color_gradientn(colors = contPalette, name = "early to late hpf") +
  facet_wrap(~ gene, scales = "free_y") +
  custom_theme()

ct_plot
# ggplotly(ct_plot)

#--------------------------------------------------------------------------------
# confirm actin Ct values don't change with treatment/development
#--------------------------------------------------------------------------------

anova_rawCt <- summarised_data %>%
  group_by(gene) %>%
  nest() %>%
  mutate(
    model = map(data, ~ aov(mean_Ct ~ group * stage, data = .x)),
    tidied = map(model, broom::tidy)
  ) %>%
  unnest(tidied) %>%
  select(gene, term, df, sumsq, meansq, statistic, p.value) %>%
  mutate(
    p.value = round(p.value, 6),
    significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**", 
      p.value < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  )

anova_rawCt %>%
  format_pvalues() %>%
  kable(digits = 4, caption = "Quality control: ANOVA raw Ct  showing actin stability")
# actin: Non-significant effects - reference gene is stable

```

## ΔCt Calculation

```{r}

# Delta-Ct method: difference between Ct of housekeeping gene and target gene
goi_data <- summarised_data %>% 
  filter(gene != "actin") %>% 
  dplyr::rename("goiMean_Ct" = "mean_Ct")

ref_data <- summarised_data %>% 
  filter(gene == "actin") %>% 
  dplyr::rename("refMean_Ct" = "mean_Ct")

delta_Ct <- left_join(goi_data, ref_data, 
                      by = c("group", "hpf", "stage","bioRep")) |> 
  dplyr::rename(gene_goi = gene.x,
                goi_Ct = goiMean_Ct,
                ref_Ct = refMean_Ct) |> 
  relocate(group,bioRep, everything()) |> 
  mutate(delta_Ct = goi_Ct - ref_Ct, # deltaCt
         mRNArel=2^(-delta_Ct) # relative mRNA
         )

# Plot delta_Ct for each sample
delta_ct_plot <- ggplot(delta_Ct, aes(x = group, y = delta_Ct, colour = hpf)) +
  geom_point(size = 2, alpha = 0.7) +
  scale_color_gradientn(colors = contPalette, name = "early to late hpf") +
  facet_wrap(~ gene_goi, scales = "fixed") +
  labs(x = "", 
       y = "ΔCt (Target Gene - Reference)") +
  custom_theme()

delta_ct_plot

# look at distributions at each timepoint
delta_Ct %>%
  group_by(stage, hpf, group) %>%
  summarise(
    mean_mRNArel = mean(mRNArel),
    sd_mRNArel = sd(mRNArel),
    n = n(),
    .groups = "drop"
  ) %>%
  kable(digits = 6, caption = "mRNArel by Stage and Group")

```

# Statistical analysis

-   mRNA expression p-values - mostly interested whether +/- nkx2.1, is thr expression changing at each points?

```{r}

# Does Nkx2.1 knockdown reduce expression at each developmental stage?

#------------------------------------
#  Wilcoxon tests
#------------------------------------
# Wilcoxon tests for group comparisons at each stage

stat_wilcox <- delta_Ct %>%
  group_by(stage, hpf) %>%
  wilcox_test(mRNArel ~ group) %>%
  adjust_pvalue(method = "fdr") %>% # this is for correcting multiple comparison, but im interesteind in the level expression +/- KD at each timepoint
  add_significance() %>%
  mutate(test_type = "Mann-Whitney U (independent samples)",
         design = "Independent biological replicates across timepoints")

# 2. Add effect sizes to show biological relevance, not just statistical significance
wilcox_with_effects <- delta_Ct %>%
  group_by(stage, hpf) %>%
  rstatix::wilcox_effsize(mRNArel ~ group) %>%
  left_join(stat_wilcox, by = c("stage", "hpf", "group1", "group2")) %>%
  dplyr::select(stage, hpf, group1, group2, p.adj, p.adj.signif, effsize, magnitude)

# pretty table
wilcox_with_effects %>%
  kable(digits = 4, format.args = list(scientific = TRUE), caption = "Wilcoxon Test Results by Stage with Effect Sizes")

```

-   7.7x reduction at earTII (0.0042 → 0.0005)
-   31.3x reduction at midTII (0.0075 → 0.0002)
-   76.9x reduction at latTII (0.0177 → 0.0002)
-   28.5x reduction at latTIII (0.0307 → 0.0011)
-   38.3x reduction at larva (0.0702 → 0.0018)

## Extra Stats

-   if I were to test for the global pattern over the time series =\> anova

    | gene_goi | term        | interpretation                             |
    |----------|-------------|--------------------------------------------|
    | thr      | group       | Does Nkx2.1 knockdown affect *thr*?        |
    | thr      | stage       | Does developmental stage affect *thr*?     |
    | thr      | group:stage | Does the knockdown effect depend on stage? |

    ```{r}

    #------------------------------------
    # ANOVA for time series effect
    #------------------------------------
    # # if multiple genes tested asame time
    # anova_results <- delta_Ct %>%
    #   group_by(gene_goi) %>%
    #   nest() %>%
    #   mutate(
    #     model = map(data, ~ aov(delta_Ct ~ group * stage, data = .x)),
    #     tidied = map(model, broom::tidy)
    #   ) %>%
    #   unnest(tidied) 
    # 
    # anova_results %>%
    #   select(-2, -3) %>%
    #   mutate(p.value = sprintf("%.3e", p.value)) %>% 
    #   kable(digits = 2, caption = "ANOVA Results for Time Series Effect")
    # 
    # anova_results

    # Two-way ANOVA for single gene (thr) expression
    aov_result <- aov(mRNArel ~ group * stage, 
                      data = delta_Ct %>% mutate(gene_goi = droplevels(gene_goi)))
    aov_result %>% 
      broom::tidy() %>% 
      format_pvalues() %>%
      kable(caption = "Two-way ANOVA: Group and Stage Effects")

    # Tukey post-hoc tests 
    tukey_results <- TukeyHSD(aov_result)
    #tukey_group <- TukeyHSD(aov_result, which = "group") # for just the group term
    # tukey_interaction <- TukeyHSD(aov_result, which = "group:stage") # for jusy interaction term

    tukey_results %>% 
      broom::tidy() |> 
      dplyr::mutate(p.adj = sprintf("%.3e", adj.p.value)) %>%
      dplyr::filter(term == "group" | term == "stage") |> 
      kable(caption = "Tukey HSD Post-hoc Tests")

    ```

    This is extra QC of the stat analysys

```{r}

# Does the knockdown alter the developmental trajectory (not just levels at each timepoint)
# eg checking the effect over time

#------------------------------------
# First check interaction time and KD
#------------------------------------
# Is the interaction model significantly better than the simpler model?
# Does adding the group×time interaction significantly improve the model?

# Compare models with and without interaction
# Null model: mRNArel ~ group + hpf (parallel lines)
null_model <- lm(mRNArel ~ group + hpf, data = delta_Ct)
# Full model: mRNArel ~ group * hpf (different slopes)
full_model <- lm(mRNArel ~ group * hpf, data = delta_Ct)

model_comparison <- anova(null_model, full_model)
model_comparison %>% 
  broom::tidy() %>% 
  format_pvalues() %>%
  kable(caption = "Likelihood Ratio Test: Is Interaction Model Better?")
# Model comparison: p = 4.205e-12 (interaction model is better)

#------------------------------------
# test significant interaction time and KD loking at the slope
#------------------------------------

# Simple linear model testing group × time interaction
trajectory_model <- lm(mRNArel ~ group * hpf, data = delta_Ct)
trajectory_anova <- anova(trajectory_model)
trajectory_anova %>% 
  broom::tidy() %>% 
  format_pvalues() %>%
  kable(caption = "Mixed Model ANOVA: Group × Time Interaction")
# Compare slopes between groups
# Are the linear slopes (rate of change over time) different between groups?
# Does the knockdown change how fast expression increases/decreases over development?

slope_comparison <- emtrends(trajectory_model, ~ group, var = "hpf")
slope_test <- pairs(slope_comparison)
slope_test %>% 
  broom::tidy() %>% 
  format_pvalues() %>%
  kable(caption = "Slope Comparison Between Groups")

# Polynomial model to test curvature differences
# Are the curves/shapes of the trajectories different?
# Does the knockdown change the curvature/non-linear pattern of development?

poly_model <- lm(mRNArel ~ group * poly(hpf, 2), data = delta_Ct)
poly_anova <- anova(poly_model)
poly_anova %>% 
  broom::tidy() %>% 
  format_pvalues() %>%
  kable(caption = "Polynomial Model: Testing Curvature Differences")

# plot with the different trajectories 
trajectory_plot <- delta_Ct %>%
  ggplot(aes(x = hpf, y = mRNArel, color = group, fill = group)) +
  geom_point(alpha = 0.7, size = 5, shape = 21, color = "black") +
  geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = TRUE, alpha = 0.2, size = 1.5) +
  labs(subtitle = "significant goup x time interaction: p = 3.7e-11***\nSlopes significantly different: p < 0.0001***",
       x = "Hours Post Fertilization (hpf)",
       y = "Relative mRNA Expression (2^-ΔCt)",
       caption = "Most probably other genes on top of Nkx2.1 regulate Thr expression late in development"
  ) +
  scale_y_continuous(trans = "log10") +
  scale_color_manual(
    values = c("control" = "grey40", "sg Nkx2.1" = "#D55E00"),
    name = ""
  ) +
  scale_fill_manual(
    values = c("control" = "grey78", "sg Nkx2.1" = "#D55E00"),
    name = ""
  ) + 
  custom_theme() +  
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 12, face = "italic"),
    legend.position = "bottom"
  )

trajectory_plot

```

Overall conclusion: Nkx2.1 regulates both the magnitude and temporal patterning of thr expression during embryonic development. Nkx2.1 control thr expression dynamics during early-mid development, but late expression is compensated by alternative
regulatory mechanisms, explaining the partial rather than complete abolition observed in both qPCR and reporter assays.

1.  **Controls**\
    Reference gene (actin) validation confirms stable expression across all conditions (p \> 0.3), ensuring observed effects are biologically meaningful rather than technical artifacts.

<!-- -->

1.  **Highly Effective Knockdown**\
    Nkx2.1 CRISPR-Cas9 knockdown significantly reduces thyroid hormone receptor (thr) expression across all developmental stages (p \< 0.01 at each timepoint) with large effect sizes (Cohen's d = 0.83).

2.  **Stage-Dependent Effects**\
    thr expression shows strong developmental regulation in controls (p \< 0.0001), increasing \~17-fold from 9.3 to 17.5 hpf, but this pattern is disrupted by Nkx2.1 knockdown.

3.  The knockdown changes the developmental pattern, not just expression levels (GROUP × TIME interaction: p = 3.7e-11), with significantly different slopes and curvature between groups. This is consistent with the reporter assay showing **diminished but
    not abolished Thr** expression in **ΔNkx2.1 binding site** reporter data. Nkx2.1 acts as a **developmental modulator** rather than simple on/off switch, regulating expression magnitude early while other factors contribute to late developmental timing.

### Panel plot

1.  <div>

    ```{r}
    # axis range & breaks
    y_range <- range(delta_Ct$mRNArel, na.rm = TRUE)
    y_breaks <- round(10^(seq(log10(y_range[1]), log10(y_range[2]), length.out = 5)),4)
    x_labels <- unique(delta_Ct$stage)
    x_breaks <- unique(delta_Ct$hpf)
    combined_labels <- paste(x_labels, "\n", x_breaks)

    # Determine the maximum y-value at each x break and add p-values onto the bar plots from stat_wilcox
    max_y_values <- tapply(delta_Ct$mRNArel, delta_Ct$hpf, max)
    spacing_constant <- 0.01
    y_positions <- max_y_values + spacing_constant

    # annotation df with p-values
    annotations_df <- stat_wilcox %>%
      left_join(distinct(delta_Ct, stage, hpf), by = c("stage","hpf")) %>%
      mutate(
        label = case_when(
          p.adj < 0.001 ~ "***",
          p.adj < 0.01 ~ "**", 
          p.adj < 0.05 ~ "*",
          TRUE ~ "ns"
        ),
        y_pos = y_positions[as.character(hpf)]
      )

    # mRNA expression plot with p-values annotations
    mRNA_plot <- delta_Ct %>%
      ggplot(aes(x = hpf, y = mRNArel, group = group, color = group, fill = group)) +
      geom_point(alpha = 0.5, size = 6, shape = 21, color = "black") +
      # geom_smooth(aes(fill = group), size=2,method = "loess", se = TRUE) + # line + CI
      stat_summary(fun = mean, geom = "line", linewidth = 1.5) +
      stat_summary(fun.data = mean_sd, geom = "ribbon", alpha = 0.3, color = NA) +
      labs(x = "Developmental stage - hpf", 
           y = "Relative mRNA Expression Thr (2^-ΔCt)") +
      scale_y_continuous(trans = "log10", breaks = y_breaks) +
      scale_x_continuous(breaks = x_breaks, labels = combined_labels) +
      scale_color_manual(values = c("control" = "grey78", "sg Nkx2.1" = "#009E73"), name = "") +
      scale_fill_manual(values = c("control" = "grey78", "sg Nkx2.1" = "#009E73"), name = "") + 
      geom_text(data = annotations_df, 
                aes(x = hpf, y = y_pos, label = label), 
                size = 15, inherit.aes = FALSE, fontface = "bold") +
      theme(legend.position = c(0.2, 0.9),
              axis.title.x=element_blank()) +
      custom_theme() 

    mRNA_plot

    # ggsave(filename = "plot_cas9_TSmRNA_plot.pdf", plot = mRNA_plot, width = 12, height = 8, dpi = 300)


    ```

    </div>

Early stages: Knockdown suppresses thr developmental increase

Late stages: Some recovery/compensation appears

## saving

```{r}

width_in <- 40 
aspect_ratio <- 3/4   
height_in <- width_in * aspect_ratio

width_mm <- 4*width_in / 25.4
height_mm <- 4*height_in / 25.4
  
  
CairoPDF(file.path(file_path,  "figSX_thr_qPCR_nkx2.1-KD.pdf"), width = width_mm, height = height_mm)
print(mRNA_plot)
dev.off()
  

# Using aspect ratio instead of explicit dimensions
cowplot::save_plot(
  plot = mRNA_plot,
  base_height = height_in,  # or any base height
  base_asp = width_in / height_in,  # width:height ratio
  file = file.path(file_path, "figSX_thr_qPCR_nkx2.1-KD_1.pdf")
)

cowplot::save_plot(plot = mRNA_plot,
                   base_height = 0.9*3.71,
                   base_asp = 0.9*1.618,
                   file = file.path(file_path,'figSX_thr_qPCR_nkx2.1-KD_2.pdf'))

```
